// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Message {
  id      Int    @id @default(autoincrement())
  content String
}

model User {
  id            String          @id @default(cuid())
  name          String?
  email         String          @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
  // Optional for WebAuthn support
  Authenticator Authenticator[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // security
  password         String
  salt             String
  iterations       Int
  resetToken       String?
  resetTokenExpiry DateTime?

  // custom
  username  String @unique
  firstName String
  lastName  String

  profile Profile
  // Exclusive and conditional sub-profile by profile type.
  studentProfile  StudentProfile? // if profile = student
  externalProfile ExternalProfile? // if profile = external

  // Free-form label from a config list (stats only).
  educationLevel String? // ex: "Seconde", "BTS 1ère année"

  // Admin roles (app convenience).
  pedagogicalAdmin Boolean @default(false)
  globalAdmin      Boolean @default(false)

  // Account status.
  blocked Boolean @default(false)

  // User consents (GDPR, terms, etc.)
  consents       UserConsent[]

  // Domain
  openBadgeProgresses OpenBadgeProgress[]
  eventRegistrations  EventRegistration[]
  createdEvents       Event[]            @relation("EventCreator")
  createdEventTemplates EventTemplate[]  @relation("EventTemplateCreator")
  createdOpenBadges   OpenBadge[]        @relation("OpenBadgeCreator")
  createdMachines     Machine[]          @relation("MachineCreator")
  createdMachineReservations MachineReservation[] @relation("MachineReservationCreator")
  machineReservationParticipants MachineReservationParticipant[]
  openBadgeLevelAwards OpenBadgeLevelProgress[] @relation("OpenBadgeLevelProgressAwardedBy")
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

// Optional for WebAuthn support
model Authenticator {
  credentialID         String  @unique
  userId               String
  providerAccountId    String
  credentialPublicKey  String
  counter              Int
  credentialDeviceType String
  credentialBackedUp   Boolean
  transports           String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, credentialID])
}

// ---------- Consent per user ----------
model UserConsent {
  id        String      @id @default(cuid())
  userId    String
  type      ConsentType
  accepted  Boolean     @default(false) // current state (not full history)
  acceptedAt DateTime?
  revokedAt  DateTime?

  user User @relation(fields: [userId], references: [id])

  // One row per (user, type) -> current state.
  @@unique([userId, type])
}

// ============================================================
// ENUMS
// ============================================================
enum ConsentType {
  terms
}

enum Profile {
  student
  teacher
  external
}

enum StudentProfile {
  visitor
  member
  alumni
}

enum ExternalProfile {
  contributor
  visitor
}

// ============================================================
// DOMAIN MODELS (V0.1)
// ============================================================
model Event {
  id        String   @id @default(cuid())
  name      String
  description String
  audience  String
  startDate DateTime
  endDate   DateTime
  maxParticipants Int?
  creatorId String
  creator   User     @relation("EventCreator", fields: [creatorId], references: [id])
  registrations EventRegistration[]

  roomId String
  room   Room  @relation(fields: [roomId], references: [id])

  templateId String
  template   EventTemplate @relation(fields: [templateId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EventTemplate {
  id              String   @id @default(cuid())
  name            String
  type            String
  maxParticipants Int?
  description     String
  profiles        Profile[]
  pointsEnabled   Boolean  @default(false)
  creatorId       String
  creator         User     @relation("EventTemplateCreator", fields: [creatorId], references: [id])

  events Event[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EventRegistration {
  id        String         @id @default(cuid())
  eventId   String
  event     Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId    String
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    RegistrationStatus @default(registered)
  registeredAt DateTime    @default(now())
  attendedAt DateTime?

  @@unique([eventId, userId])
}

enum RegistrationStatus {
  registered
  attended
  cancelled
  noShow
}

model OpenBadge {
  id            String         @id @default(cuid())
  type          String
  name          String
  coverImage    String?
  description   String?
  awardedPdfUrl String?
  status        ActivityStatus @default(active)
  pointsEnabled Boolean        @default(false)
  category      String

  creatorId String
  creator   User   @relation("OpenBadgeCreator", fields: [creatorId], references: [id])

  openBadgeProgresses OpenBadgeProgress[]
  trainerThresholdLevelId String?
  trainerThresholdLevel   OpenBadgeLevel? @relation("OpenBadgeTrainerThreshold", fields: [trainerThresholdLevelId], references: [id])

  machines MachineOpenBadgeRequirement[]

  levels OpenBadgeLevel[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OpenBadgeLevel {
  id          String    @id @default(cuid())
  level       Int
  title       String
  description String?
  openBadgeId String
  openBadge   OpenBadge @relation(fields: [openBadgeId], references: [id], onDelete: Cascade)
  trainerThresholdFor OpenBadge[] @relation("OpenBadgeTrainerThreshold")
  highestLevelFor OpenBadgeProgress[] @relation("OpenBadgeProgressHighestLevel")
  levelProgressEntries OpenBadgeLevelProgress[] @relation("OpenBadgeLevelProgressLevel")
  requiredBy MachineOpenBadgeRequirement[] @relation("RequiredOpenBadgeLevel")

  @@unique([openBadgeId, level])
}

model OpenBadgeProgress {
  id             String          @id @default(cuid())
  userId         String
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  openBadgeId    String
  openBadge      OpenBadge       @relation(fields: [openBadgeId], references: [id], onDelete: Cascade)
  highestLevelId String?
  highestLevel   OpenBadgeLevel? @relation("OpenBadgeProgressHighestLevel", fields: [highestLevelId], references: [id])
  levelHistory   OpenBadgeLevelProgress[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, openBadgeId])
  @@index([openBadgeId, highestLevelId])
}

model OpenBadgeLevelProgress {
  id               String          @id @default(cuid())
  progressId       String
  progress         OpenBadgeProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)
  openBadgeLevelId String
  openBadgeLevel   OpenBadgeLevel  @relation("OpenBadgeLevelProgressLevel", fields: [openBadgeLevelId], references: [id], onDelete: Cascade)
  awardedAt        DateTime        @default(now())
  awardedById      String
  awardedBy        User            @relation("OpenBadgeLevelProgressAwardedBy", fields: [awardedById], references: [id])

  @@unique([progressId, openBadgeLevelId])
  @@index([progressId, awardedAt(sort: Desc)])
}

model Machine {
  id                  String         @id @default(cuid())
  category            String
  name                String
  description         String?
  imageUrl            String?
  roomId              String?
  room                Room?          @relation(fields: [roomId], references: [id])
  reservationCalendarUrl String?
  status              ActivityStatus @default(active)
  pointsEnabled       Boolean        @default(false)
  creatorId           String
  creator             User           @relation("MachineCreator", fields: [creatorId], references: [id])
  badgeRequirements   MachineOpenBadgeRequirement[]
  reservations        MachineReservation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MachineReservation {
  id        String   @id @default(cuid())
  machineId String
  machine   Machine  @relation(fields: [machineId], references: [id], onDelete: Cascade)
  creatorId String
  creator   User     @relation("MachineReservationCreator", fields: [creatorId], references: [id])
  startsAt  DateTime
  endsAt    DateTime
  status    MachineReservationStatus @default(confirmed)
  participants MachineReservationParticipant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([machineId, startsAt])
  @@index([creatorId, startsAt])
}

model MachineReservationParticipant {
  id            String             @id @default(cuid())
  reservationId String
  reservation   MachineReservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  userId        String
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt     DateTime           @default(now())

  @@unique([reservationId, userId])
  @@index([userId])
}

model MachineOpenBadgeRequirement {
  id                       String         @id @default(cuid())
  machineId                String
  machine                  Machine        @relation(fields: [machineId], references: [id], onDelete: Cascade)
  requiredOpenBadgeId      String
  requiredOpenBadge        OpenBadge       @relation(fields: [requiredOpenBadgeId], references: [id], onDelete: Cascade)
  requiredOpenBadgeLevelId String?
  requiredOpenBadgeLevel   OpenBadgeLevel? @relation("RequiredOpenBadgeLevel", fields: [requiredOpenBadgeLevelId], references: [id])
  ruleType                 OpenBadgeRequirementRule @default(all)

  @@unique([machineId, requiredOpenBadgeId, requiredOpenBadgeLevelId])
}

enum OpenBadgeRequirementRule {
  all
  any
}

model Location {
  id    String @id @default(cuid())
  name  String
  rooms Room[]
}

model Room {
  id            String    @id @default(cuid())
  name          String
  number        Int?
  eventCalendarUrl String?
  locationId    String?
  location      Location? @relation(fields: [locationId], references: [id])
  events        Event[]
  machines      Machine[]
}

enum ActivityStatus {
  active
  inactive
}

enum MachineReservationStatus {
  confirmed
  cancelled
}
